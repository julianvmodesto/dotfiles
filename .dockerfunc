#!/bin/bash
# Bash wrappers for docker run commands

export DOCKER_REPO_PREFIX=julianvmodesto

#
# Helper Functions
#
del_stopped(){
  local name=$1
  local state
  state=$(docker inspect --format "{{.State.Running}}" "$name" 2>/dev/null)

  if [[ "$state" == "false" ]]; then
    docker rm "$name"
  fi
}
relies_on(){
  for container in "$@"; do
    local state
    state=$(docker inspect --format "{{.State.Running}}" "$container" 2>/dev/null)

    if [[ "$state" == "false" ]] || [[ "$state" == "" ]]; then
      echo "$container is not running, starting it for you."
      $container
    fi
  done
}
#
# Container Aliases
#
firefox(){
  del_stopped firefox

  docker run -d \
    --memory 3gb \
    --shm-size 1gb \
    --net host \
    --cpuset-cpus 0 \
    -v /etc/localtime:/etc/localtime:ro \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -v "${HOME}/.firefox/cache:/root/.cache/mozilla" \
    -v "${HOME}/.firefox/mozilla:/root/.mozilla" \
    -v "${HOME}/Downloads:/root/Downloads" \
    -v "${HOME}/Pictures:/root/Pictures" \
    -v "${HOME}/Torrents:/root/Torrents" \
    -e "DISPLAY=unix${DISPLAY}" \
    -e GDK_SCALE \
    -e GDK_DPI_SCALE \
    --device /dev/snd \
    --device /dev/dri \
    --device /dev/bus/usb \
    --group-add audio \
    --group-add video \
    --name firefox \
    ${DOCKER_REPO_PREFIX}/firefox "$@"

  # exit current shell
  exit 0
}
jq(){
  docker run -i --rm \
    --name jq \
    ${DOCKER_REPO_PREFIX}/jq "$@"
}
export -f jq
landscape(){
  docker run -i --rm \
    --name landscape \
    ${DOCKER_REPO_PREFIX}/landscape "$@"
}
notify_osd(){
  del_stopped notify_osd

  docker run -d \
    -v /etc/localtime:/etc/localtime:ro \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    --net none \
    -v /etc \
    -v "${HOME}/.dbus:/home/user/.dbus" \
    -v "${HOME}/.cache/dconf:/home/user/.cache/dconf" \
    -e "DISPLAY=unix${DISPLAY}" \
    --name notify_osd \
    ${DOCKER_REPO_PREFIX}/notify-osd
}
alias notify-send=notify_send
notify_send(){
  relies_on notify_osd
  local args=${*:2}
  docker exec -i notify_osd notify-send "$1" "${args}"
}
zeal() {
  del_stopped zeal

  docker run -d \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -e "DISPLAY=unix${DISPLAY}" \
    --device /dev/dri \
    --name=zeal \
    ${DOCKER_REPO_PREFIX}/zeal

  # exit current shell
  exit 0
}
